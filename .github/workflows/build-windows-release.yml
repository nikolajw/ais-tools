name: Build Windows Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0'

      - name: Restore dependencies
        run: dotnet restore src/AisReplay.csproj

      - name: Build project
        run: dotnet build src/AisReplay.csproj --configuration Release --no-restore

      - name: Publish for Windows
        run: dotnet publish src/AisReplay.csproj --configuration Release --runtime win-x64 --self-contained --output ./publish/windows-x64

      - name: Create archive
        shell: pwsh
        run: |
          cd publish
          Compress-Archive -Path windows-x64 -DestinationPath aisreplay-windows-x64.zip
          Get-ChildItem *.zip | Format-List FullName, Length

      - name: Get version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.ref }}".StartsWith("refs/tags/")) {
            $VERSION = "${{ github.ref_name }}"
            if ($VERSION.StartsWith("v")) {
              $VERSION = $VERSION.Substring(1)  # Remove 'v' prefix if present
            }
          } else {
            $VERSION = (Get-Date -Format 'yyyy.MM.dd') + '-' + (git rev-parse --short HEAD)
          }
          "version=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: ncipollo/release-action@v1
        with:
          artifacts: "./publish/aisreplay-windows-x64.zip"
          draft: false
          prerelease: false
          name: Release ${{ steps.version.outputs.version }}
          tag: ${{ steps.version.outputs.version }}
          allowUpdates: true
          body: "Windows build for AisReplay"
          token: ${{ github.token }}
